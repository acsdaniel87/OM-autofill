<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>OM JSON konvertÃ¡lÃ³</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 720px; margin: auto; padding: 20px; }
    h1 { color: #003d66; }
    input, button, textarea { font-size: 16px; margin-top: 10px; width: 100%; padding: 8px; }
    #drop { border: 2px dashed #ccc; padding: 30px; text-align: center; color: #666; margin-bottom: 15px; }
    #progress { width: 100%; height: 20px; background: #eee; border: 1px solid #ccc; margin-top: 10px; }
    #bar { height: 100%; width: 0%; background: #007b5e; transition: width 0.4s ease; }
    #log { background: #f9f9f9; border: 1px solid #ddd; font-size: 14px; padding: 8px; margin-top: 10px; height: 120px; overflow-y: auto; white-space: pre-line; }
  </style>
</head>
<body>

<h1>ğŸ“¥ OM .xlsx â JSON konvertÃ¡lÃ¡s Ã©s GitHub feltÃ¶ltÃ©s</h1>

<div id="drop">ğŸ‘‰ HÃºzd ide a <strong>kir_mukodo_intezmenyek*.xlsx</strong> fÃ¡jlt vagy vÃ¡laszd ki:</div>
<input type="file" id="fileInput" accept=".xlsx">

<label>ğŸ”‘ GitHub Personal Access Token:</label>
<input type="password" id="token" placeholder="ghp_xxx..." />

<div id="progress"><div id="bar"></div></div>
<div id="log"></div>

<button id="uploadBtn">ğŸ“¤ FeltÃ¶ltÃ©s GitHubra (JSON)</button>

<script>
let jsonData = "";
let shaOfExisting = null;
const repo = "acsdaniel87/OM-autofill";

function log(msg) {
  const box = document.getElementById("log");
  box.textContent += msg + "\n";
  box.scrollTop = box.scrollHeight;
}

function updateProgress(percent) {
  document.getElementById("bar").style.width = percent + "%";
}

function saveTokenToSession() {
  const tokenValue = document.getElementById("token").value.trim();
  if (tokenValue.length > 10) sessionStorage.setItem("githubToken", tokenValue);
}

function loadTokenFromSession() {
  const saved = sessionStorage.getItem("githubToken");
  if (saved) document.getElementById("token").value = saved;
}

function handleFile(file) {
  const tokenField = document.getElementById("token").value.trim();
  if (!tokenField) {
    alert("ğŸ” KÃ©rlek, add meg a GitHub tokened a fÃ¡jl feldolgozÃ¡sÃ¡hoz.");
    return;
  }

  if (!file.name.includes("kir_mukodo_intezmenyek") || !file.name.endsWith(".xlsx")) {
    alert("âŒ Csak megfelelÅ‘ nevÅ± .xlsx fÃ¡jl engedÃ©lyezett!");
    return;
  }

  log("ğŸ“¦ FÃ¡jl betÃ¶ltÃ©se: " + file.name);
  log("ğŸ” Token ellenÅ‘rizve.");
  updateProgress(10);
  saveTokenToSession();

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const header = rows[0];
    if ((header[0] || "").trim() !== "OM azonosÃ­tÃ³" || (header[1] || "").trim() !== "IntÃ©zmÃ©ny megnevezÃ©se") {
      alert("âŒ HibÃ¡s fejlÃ©c! ElvÃ¡rt: 'OM azonosÃ­tÃ³;IntÃ©zmÃ©ny megnevezÃ©se'");
      return;
    }

    log("âœ… FejlÃ©c rendben. Sorok feldolgozÃ¡sa...");
    updateProgress(40);

    const outputObj = {};
    rows.slice(1).forEach(r => {
      const om = (r[0] || "").toString().trim();
      const name = (r[1] || "").toString().trim();
      if (om && name) outputObj[om] = name;
    });

    jsonData = JSON.stringify(outputObj, null, 2);
    log("âœ… KonvertÃ¡lÃ¡s JSON formÃ¡tumba kÃ©sz.");
    updateProgress(70);
  };
  reader.readAsArrayBuffer(file);
}

function fetchExistingSha(repo, token, path) {
  return fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
    headers: { Authorization: `Bearer ${token}` }
  })
  .then(res => res.ok ? res.json() : Promise.reject("âŒ Nem Ã©rhetÅ‘ el a fÃ¡jl."))
  .then(data => data.sha);
}

document.getElementById("drop").ondragover = e => e.preventDefault();
document.getElementById("drop").ondrop = e => {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  document.getElementById("fileInput").files = e.dataTransfer.files;
  handleFile(file);
};

document.getElementById("fileInput").onchange = e => handleFile(e.target.files[0]);
window.onload = loadTokenFromSession;

document.getElementById("uploadBtn").onclick = async () => {
  const token = document.getElementById("token").value.trim();
  const repo = document.getElementById("repo").value.trim();
  const path = "azonositok/intezmenyek.json";

  if (!token || !repo || !jsonData) {
    alert("â— Token, repo Ã©s konvertÃ¡lt adat szÃ¼ksÃ©ges!");
    return;
  }

  log("ğŸ“¡ SHA lekÃ©rÃ©se...");
  try {
    shaOfExisting = await fetchExistingSha(repo, token, path);
    log("âœ… SHA: " + shaOfExisting);
  } catch (e) {
    log("â„¹ï¸ Nem talÃ¡ltam meglÃ©vÅ‘ fÃ¡jlt â€” ÃºjkÃ©nt tÃ¶ltjÃ¼k fel.");
  }

  const payload = {
    message: "Automatikus JSON feltÃ¶ltÃ©s bÃ¶ngÃ©szÅ‘bÅ‘l",
    content: btoa(unescape(encodeURIComponent(jsonData))),
    sha: shaOfExisting || undefined
  };

  updateProgress(90);
  log("ğŸ“¤ FeltÃ¶ltÃ©s GitHubra...");

  fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
    method: "PUT",
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if (data.commit && data.commit.sha) {
      log("âœ… Sikeres feltÃ¶ltÃ©s! Commit: " + data.commit.sha);
    } else {
      log("âœ… FeltÃ¶ltÃ©s megtÃ¶rtÃ©nt, de nincs commit SHA.");
    }
    updateProgress(100);
  })
  .catch(err => {
    log("âŒ FeltÃ¶ltÃ©si hiba: " + err);
    updateProgress(0);
  });
};
</script>
</body>
</html>
